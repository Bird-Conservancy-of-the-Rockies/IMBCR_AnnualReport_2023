<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="6-methods_files/libs/clipboard/clipboard.min.js"></script>
<script src="6-methods_files/libs/quarto-html/quarto.js"></script>
<script src="6-methods_files/libs/quarto-html/popper.min.js"></script>
<script src="6-methods_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="6-methods_files/libs/quarto-html/anchor.min.js"></script>
<link href="6-methods_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="6-methods_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="6-methods_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="6-methods_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="6-methods_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">



<section id="methods" class="level1">
<h1>Methods</h1>
<section id="study-area" class="level2">
<h2 class="anchored" data-anchor-id="study-area">Study Area</h2>
<p>In 2022, the IMBCR program’s area of inference encompassed four entire states (Colorado, Montana, Utah, and Wyoming) and portions of 11 additional states (Arizona, California, Idaho, Kansas, Nebraska, Nevada, New Mexico, North Dakota, Oklahoma, Oregon, and South Dakota). We surveyed across US Forest Service (USFS) Regions 1, 2, and 4 and in portions of Region 3; all of the Badlands and Prairies Bird Conservation Region (BCR 17), and portions of nine other BCRs: Great Basin (9), Northern Rockies (10), Prairie Potholes (11), Sierra Nevada (15), Southern Rockies/Colorado Plateau (16), Shortgrass Prairie (18), Central Mixed Grass Prairie (19), Sonoran and Mojave Deserts (33), and Sierra Madre Occidental (34).</p>
<div id="fig-extent" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="IMBCR_Extent_Map_2022.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Spatial extent of sampled Bird Conservation Regions using the IMBCR design, 2022</figcaption>
</figure>
</div>
</section>
<section id="sampling-design" class="level2">
<h2 class="anchored" data-anchor-id="sampling-design">Sampling Design</h2>
<section id="sampling-frame-and-stratification" class="level3">
<h3 class="anchored" data-anchor-id="sampling-frame-and-stratification">Sampling Frame and Stratification</h3>
<p>A key feature of the IMBCR design is the ability to estimate bird population parameters at multiple spatial scales, from small management units, such as individual national forests or field offices, to entire states and BCRs. This is accomplished through hierarchical (nested) sampling of smaller within larger units. The fundamental units of the design (and therefore of population estimation) are strata, which are mutually exclusive and together form the programmatic footprint in any given year. Strata-level population estimates can be combined to derive estimates at larger scales for groups of strata (hereafter superstrata). For example, data from each individual national forest stratum in USFS Region 2 are combined to produce Region-wide population estimates; data from each individual stratum in Montana are combined to produce statewide estimates; and data from each individual stratum in BCR 17 are combined to produce BCR-wide estimates.</p>
<p>We define strata based on areas to which IMBCR partners wanted to make inferences. Strata contributing to the baseline monitoring effort (hereafter background strata) are nested within the intersection of state and BCR boundaries (e.g., Wyoming-BCR 10). Additionally, we base background strata within the state-BCR sampling frames on fixed attributes, such as land ownership boundaries, elevation zones, major river systems and wilderness/roadless designations. Additional strata defined for particular objectives, such as monitoring within areas subject to management action, are not subject to the same constraints as background strata (hereafter overlay strata).</p>
</section>
<section id="sampling-units" class="level3">
<h3 class="anchored" data-anchor-id="sampling-units">Sampling Units</h3>
<p>We define sampling units as 1 km² cells, each containing 16 evenly spaced sample points, 250 meters apart (Figure 3). We define potential sampling units by superimposing a uniform grid of cells over each state in the study area. We then assign each cell to a stratum using ArcGIS version 10.X and higher (Environmental Systems Research Institute, 2017). For all stratifications developed after 2012, we use the United States National Grid (USNG), a nonproprietary alphanumeric referencing system derived from the Military Grid Reference System that was created by the Federal Geographic Data Committee.</p>
<div id="fig-sampling-unit" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="IMBCR-sampling-unit.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Example 1 km² sampling unit in the IMBCR design.</figcaption>
</figure>
</div>
</section>
<section id="sample-selection" class="level3">
<h3 class="anchored" data-anchor-id="sample-selection">Sample Selection</h3>
<p>Within each stratum, we use generalized random-tessellation stratification (GRTS), a spatially balanced sampling algorithm, to select sampling units (Stevens Jr.&nbsp;&amp; Olsen, 2004). The GRTS design has useful properties with respect to long-term monitoring of birds at large spatial scales including:</p>
<ul>
<li><p>Spatially balanced sampling is generally more efficient than simple random sampling of natural resources (Stevens Jr.&nbsp;&amp; Olsen, 2004). Incorporating information about spatial autocorrelation in the data can increase precision in density estimates.</p></li>
<li><p>All sampling units in the sampling frame are ordered, such that any set of consecutively numbered units is a spatially well-balanced sample (Stevens Jr.&nbsp;&amp; Olsen, 2004). In the case of fluctuating budgets, IMBCR partners can adjust the sampling effort among years within each stratum while still preserving a random, spatially balanced sampling design.</p></li>
</ul>
<p>We require two sampling units to be surveyed within each stratum, but reliable stratum-level occupancy estimates require larger sample sizes, with a minimum of approximately 8-10 samples per stratum. Additional samples may be required for strata comprising large geographic areas. Because we estimate regional density and occupancy using an area weighted mean, adding more samples to a particular stratum does not bias the overall estimate, it simply increases the precision. After the initial two sampling units were selected, the remaining allocation of sampling effort among strata was based on the priorities of the funding partners.</p>
</section>
</section>
<section id="sampling-methods" class="level2">
<h2 class="anchored" data-anchor-id="sampling-methods">Sampling Methods</h2>
<p>IMBCR observers with excellent aural and visual bird-identification skills conducted field work in 2022. Prior to conducting surveys, observers completed an intensive training program to ensure full understanding of the field protocol and review bird and plant identification. Observers were also shadowed by a crew leader at the start of the field season to ensure they understood the protocol and could identify all birds within a region.</p>
<p>Observers conducted point counts (Buckland et al., 2001) following protocols established by IMBCR partners (Hanni, White, Birek, Van Lanen, &amp; McLaren, 2012). Observers conducted surveys in the morning, beginning one-half hour before sunrise and concluding no later than five hours after sunrise. Observers recorded the start time for every point count conducted. For every bird detected during the six-minute period, observers recorded species, sex, horizontal distance from the observer, minute, type of detection (e.g., call, song, visual), whether the bird was thought to be a migrant, and whether the observer was able to visually identify each record.</p>
<p>Observers measured distances to each bird using laser rangefinders when possible. When it was not possible, observers estimated the distance by measuring to some object near the bird using a laser rangefinder. In addition to recording all bird species detected in the area during point counts, observers recorded birds flying over but not using the immediate surrounding landscape. Observers also recorded Abert’s squirrel (Sciurus aberti), American red squirrel (Tamiasciurus hudsonicus), and American pika (Ochotona princeps). While observers traveled between points within a sampling unit, they recorded the presence of any species not recorded during a point count. The opportunistic detections of these species are used for distribution purposes only.</p>
<p>Observers considered all non-independent detections of birds (i.e., flocks or pairs of conspecific birds together in close proximity) as part of a “cluster” rather than as independent observations. Observers recorded the number of birds detected within each cluster along with a letter code to distinguish between multiple clusters.</p>
<p>At the start and end of each survey, observers recorded time, ambient temperature, cloud cover, precipitation, and wind speed. Observers navigated to each point using hand-held Global Positioning System units. Before beginning each six-minute count, surveyors recorded vegetation data within a 50m radius of the point via ocular estimation. Vegetation data included the dominant habitat type and relative abundance, percent cover and mean height of trees and shrubs by species, grass height, and ground cover. Observers recorded vegetation data quietly to allow birds time to return to their normal habits prior to beginning each count.</p>
<p>For more detailed information about survey methods and vegetation data collection protocols, refer to Bird Conservancy’s Field Protocol for Spatially Balanced Sampling of Landbird Populations on our <a href="http://rmbo.org/v3/avian/DataCollection.aspx">Avian Data Center</a>. You will also find links to past and current protocols and data sheets.</p>
</section>
<section id="data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="data-analysis">Data Analysis</h2>
<section id="framework-and-terminology" class="level3">
<h3 class="anchored" data-anchor-id="framework-and-terminology">Framework and terminology</h3>
<p>We implemented a unified framework for data analysis and estimation of abundance, density, occupancy, and their respective trends. Hereafter, we refer to abundance, density, and occupancy as “primary population parameters”, or simply “population parameters”, and estimates of these parameters as “population estimates”. Abundance is the number of species members present within a specified areal unit and time frame. Density is abundance per unit area (birds per <span class="math inline">\(km^2\)</span>). Because a model that estimates abundance by definition also estimates density, we sometimes use the term “abundance” to refer to both<!--Not sure if we actually do this anywhere. If we don't, we can remove this sentence.-->. Occupancy is the probability or proportion of sampling units within an areal unit and time frame where at least one species member is present. Because population estimates are derived from data collected over 6-min surveys conducted once per sampling period (i.e., the breeding season), the time frame of estimation is 6 minutes. Thus, IMBCR abundance and occupancy estimates quantify the number of individuals present and the proportion of sampling units (or area) with <span class="math inline">\(\geq1\)</span> individual present, respectively, within a 6 minute snapshot in time. In contrast, other monitoring programs that estimate population parameters over longer time frames that allow movement into the sampling unit during the sampling period will tend to quantify the distribution of breeding territories or home ranges (i.e., space use; but see interpretation of occupancy estimates from occupancy models under <strong>Occupancy Estimation</strong> below).</p>
<p>Given our sampling design (see above), the fundamental areal unit of estimation for all parameters is the stratum, and so our models estimate abundance, density, and occupancy for all strata making up the IMBCR programmatic footprint. Additionally, our design allows us to derive population estimates for larger areal units consisting of <span class="math inline">\(\geq2\)</span> strata (hereafter superstrata) by summarizing across component strata. For density and occupancy, superstrata estimates represent means of strata weighted by their area. For abundance, we simply sum strata estimates to derive superstrata estimates. Hereafter, we use the term “areal units” to refer to strata and superstrata in general. To allow flexible trend estimation for any areal unit and time period, trend estimation involves <em>post hoc</em> analysis of annual population estimates generated by a primary estimation model (Appendix D).</p>
<p>Under this framework, we preferentially analyzed data using a hurdle model, which integrates estimation of abundance and occupancy. For ~10% of species for which hurdle model(s) failed to meet <em>a priori</em> criteria for convergence and sampling within a reasonable time frame (described further below), we estimated abundance and occupancy in separate models. We describe in detail the structure of these models (hurdle, abundance, and occupancy) in Appendix D.</p>
</section>
<section id="density-estimation" class="level3">
<h3 class="anchored" data-anchor-id="density-estimation">Density Estimation</h3>
<p>We developed a Bayesian, zero-inflated N-mixture model (Royle 2004, Sillett et al.&nbsp;2011) to estimate density and abundance for all strata and superstrata across all species with sufficient data. We used distance sampling to estimate detection probabilities and adjust counts accordingly. For a detailed description of statistical analyses performed, see (Appendix D).</p>
<p>Bayesian approaches to density estimation provide several benefits over traditional distance sampling analyses, while providing similar and unbiased estimates of density and abundance. First, with the nested design of IMBCR, point count locations within a 1-km2 grid cell are not independent. Therefore, with traditional methods, it is necessary to treat each point as a spatial replicate within the grid cell (i.e., average counts across points). However, it is unlikely that bird densities are uniform within a grid cell, and a better solution would be to estimate density at the point count location. Bayesian models provide the flexibility to do this, while correctly accounting for the lack of independence among points. The second benefit, also provided by this flexibility, is the ability to include covariates to explain changes in density. This allows us to explicitly estimate the response of bird density to variables, such as habitat variables, management actions, or time (i.e., trend). Finally, Bayesian approaches allow for sharing of information across parameters. This can assist in obtaining estimates at sites with little data or provide measures of uncertainty when no birds were detected, such as at low densities and/or small sample sizes.</p>
<p>We fit a series of models to the data from each species that had the same model structure describing density estimation but varied in detection structure (see Observation process section below). We used zero-inflation to account for excess zeros in the data, where abundance at a point count location (N) is conditional on the point’s true occupancy state (z) of a species at the point count location, and the mean abundance within a 1-km2 grid cell was modeled as a function of year to estimate stratum-specific trends.</p>
<p>All points within a grid cell shared a mean abundance to account for the lack of independence of those points, but abundance was allowed to vary spatially within a grid cell (i.e., by point) through Poisson variation. To avoid predicting species occurrence outside of observed ranges, we fixed occupancy probabilities to 0 for all strata in which the species was never observed and used a prior informed by the observed proportion of grid-year combinations in a stratum in which the species was detected.</p>
<p>We derived density at the point count location by dividing the estimated abundance by the area of the point count circle (see Observation process section below) and multiplying by cluster size. We derived stratum-level density estimates by averaging all point-level density estimates within each stratum, and we took the area-weighted average of strata estimates to obtain superstratum estimates.</p>
<p><strong>Observation process</strong></p>
<p>We estimated the probability of detecting an independent cluster of individuals by fitting distance functions to the distance data collected during surveys (Buckland et al.&nbsp;2001). We fit four detection models including:<br>
1. half-normal constant (HN(.))<br>
2. hazard rate constant (Haz(.))<br>
3. half-normal year (HN(t))<br>
4. hazard rate year (Haz(t))</p>
<p>We removed the furthest 10% of observed detection distances from the data set and binned the remaining detections into 10 evenly spaced distance classes. The furthest remaining detection distance became the radius of the point count circle with which we estimated density.</p>
<p><strong>Detection model selection</strong></p>
<p>To minimize computing time but find the most parsimonious detection function, we fit detection-only models to the distance data, using the four model structures described above. We used the Watanabe-Akaike Information Criterion (WAIC; Watanabe 2010, Hooten and Hobbs 2015) to select the most parsimonious detection structure and then used that structure for detection probabilities in the full model to estimate density and abundance.</p>
<p><strong>Trend Estimates</strong></p>
<p>We estimated trends for individual strata by calculating the least-squares regression mean and standard errors for the intercept and slope of the log densities across the monitoring period. We calculated these parameters for every Bayesian iteration to account for uncertainty around density estimates.</p>
<p>We developed a post-hoc approach to estimate trends for superstrata. Using the rolled-up estimates of density for a superstratum, we fit a general linear model (GLM) to the samples from each Bayesian iteration. Fitting a GLM across iterations allowed us to incorporate uncertainty in superstratum trends due to uncertainty around density estimates, but it did not account for temporal variation. To incorporate this second form of variation, we sampled a random intercept and slope for each iteration using the mean and standard error estimated using the GLM and made inference on the distribution of the resampled values.</p>
</section>
<section id="occupancy-estimation" class="level3">
<h3 class="anchored" data-anchor-id="occupancy-estimation">Occupancy Estimation</h3>
<p>Occupancy estimation is most commonly used to quantify the proportion of sample units (i.e., 1 km² cells) occupied by an organism (MacKenzie et al., 2002). The application of occupancy modeling requires multiple surveys of the sample unit in space or time to estimate a detection probability (MacKenzie et al., 2006). The detection probability adjusts the proportion of sites occupied to account for species that were present but undetected (MacKenzie et al., 2002). We used a removal design (MacKenzie et al., 2006), to estimate a detection probability for each species, in which we binned minutes one and two, minutes three and four and minutes five and six to meet the assumption of a monotonic decline in the detection rates through time. After the target species was detected at a point, we set all subsequent sampling intervals at that point to “missing data” (MacKenzie et al., 2006).</p>
<p>The 16 points in each sampling unit served as spatial replicates for estimating the proportion of points occupied within the sampled sampling units. We used a Bayesian, multi-scale occupancy model (Nichols et al.&nbsp;2008, Mordecai et al.&nbsp;2011, Green et al.&nbsp;2019) to estimate 1) the probability of detecting a species given presence (p), 2) the proportion of points occupied by a species given presence within sampled sampling units (θ, Theta) and 3) the proportion of sampling units occupied by a species (ψ, Psi).</p>
<p>We truncated the data, using only detections &lt;125 m from the sample points, except for Accipitriformes, Anseriformes, Falconiformes, Galliformes, Gruiformes, Pelecaniformes, Podicepidiformes, and Suliformes for which we used the maximum observed distance for each species. Truncating the data allowed us to use bird detections over a consistent plot size and ensured that the points were independent (points were spread 250 m apart), which in turn allowed us to estimate θ (the proportion of points occupied within each sampling unit) (Pavlacky Jr., Blakesley, White, Hanni, &amp; Lukacs, 2012). The interpretation of θ for species for which we used maximum distances changes from occupancy to use because point count buffers overlap, but we chose this approach to provide estimates for a larger number of species.</p>
<p>We expected regional differences in the behavior, habitat use, and local abundance of species would correspond to regional variation in detection and the fraction of occupied points. Therefore, we estimated the proportion of sampling units occupied (ψ) for each stratum by estimating BCR-by-year specific estimates of detection (p) and point-level occupancy (θ). We fixed p and θ to 0 for BCRs in which a particular species was never detected.</p>
<p>We fixed ψ to 0 for all strata in which the species was never detected. As with density, we took an area-weighted mean of stratum-level occupancy estimates (i.e.,ψ) to estimate superstratum-level occupancy probabilities. The true point-level occupancy state was conditional on the grid-cell-level occupancy state (i.e., occupied or unoccupied), such that a point could only be occupied if the grid cell was occupied. Finally, we modeled the observation process conditional on the point being occupied using removal modeling.</p>
<p>Our application of the multi-scale model was analogous to a within-season robust design (Pollock, 1982) where the two-minute intervals at each point were the secondary samples for estimating p and the points were the primary samples for estimating θ (Nichols et al., 2008; Pavlacky Jr.&nbsp;et al., 2012). We considered both p and θ to be nuisance variables that were important for generating unbiased estimates of ψ. θ can be considered an availability parameter or the probability a species was present and available for sampling at the points (Nichols et al., 2008; Pavlacky Jr.&nbsp;et al., 2012).</p>
</section>
<section id="distance-analysis-assumptions" class="level3">
<h3 class="anchored" data-anchor-id="distance-analysis-assumptions">Distance Analysis Assumptions</h3>
<p>Distance sampling theory was developed to account for the decreasing probability of detecting an object of interest (e.g., a bird) with increasing distance from the observer to the object (Buckland et al., 2001). The detection probability is used to adjust the count of birds to account for birds that were present but undetected. Application of distance theory requires that five critical assumptions be met: 1) all birds at and near the sampling location (distance = 0) are detected; 2) distances to birds are measured accurately; 3) birds do not move in response to the observer’s presence (Buckland et al., 2001; Thomas et al., 2010); 4) cluster sizes are recorded without error; and 5) the sampling units are representative of the entire survey region (Buckland, Marsden, &amp; Green, 2008).</p>
</section>
<section id="automated-analysis" class="level3">
<h3 class="anchored" data-anchor-id="automated-analysis">Automated Analysis</h3>
<p>In 2019, we updated our analytical methods to use Bayesian hierarchical models specifically designed for analysis of IMBCR data. We performed all data and output manipulation in R (R Core Team, 2022) and model fitting in JAGS (Plummer 2003, 2017) using the R package jagsUI (Kellner 2018). The R code called the raw data from the IMBCR Structured Query Language (SQL) server database and reformatted the data into a form usable with the JAGS code. We allowed the input of all data collected in a manner consistent with the IMBCR design to increase the number of detections available for estimating global detection rates for population density and site occupancy. The R code provided an automated framework for combining stratum-level estimates of population density and site occupancy at multiple spatial scales, as well as estimating the standard deviations and credible intervals for the combined estimates.</p>
<p>We fit initial models to all species with at least 30 detections for density estimation and 10 detections for occupancy estimation. For density estimation, we fit the full model after determining whether there were enough detections based on results from the detection-only model fits. In some cases for both density and occupancy estimation, it was necessary to use a less parsimonious detection structure or simplified model structure to facilitate model convergence. We currently maintain version control of the automated analysis code in the Bird Conservancy repository on www.github.com.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>